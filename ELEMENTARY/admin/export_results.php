<?php
// Include database connection
require_once '../includes/db_connect.php';

// Include TCPDF Library
require_once '../tcpdf/tcpdf.php';

// Fetch election results from vot_candidates table
try {
    $query = "SELECT * FROM vot_candidates ORDER BY position, votes DESC";
    $stmt = $pdo->prepare($query);
    $stmt->execute();
    $candidates = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    die("Database error: " . $e->getMessage());
}

// Organize candidates by position
$results_by_position = [];
foreach ($candidates as $candidate) {
    $results_by_position[$candidate['position']][] = $candidate;
}

// Create new PDF document
$pdf = new TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);

// Set document information
$pdf->SetCreator('College Voting System');
$pdf->SetAuthor('College Admin');
$pdf->SetTitle('Official Election Results');
$pdf->SetSubject('Election Report');

// Set margins
$pdf->SetMargins(15, 20, 15);
$pdf->SetHeaderMargin(10);
$pdf->SetFooterMargin(15);
$pdf->SetAutoPageBreak(TRUE, 25);

// Add a page
$pdf->AddPage();

// Title section
$pdf->SetFont('helvetica', 'B', 18);
$pdf->Cell(0, 10, 'COLLEGE OF COMPUTER STUDIES', 0, 1, 'C');
$pdf->SetFont('helvetica', 'B', 22);
$pdf->Cell(0, 12, 'OFFICIAL ELECTION RESULTS', 0, 1, 'C');

// Report date
$pdf->SetFont('helvetica', '', 11);
$pdf->Cell(0, 8, 'Generated on: ' . date('F j, Y \\'), 0, 1, 'C');
$pdf->Ln(12);

// Election results by position
foreach ($results_by_position as $position => $candidates) {
    // Position header
    $pdf->SetFont('helvetica', 'B', 14);
    $pdf->SetFillColor(240, 240, 240);
    $pdf->Cell(0, 10, strtoupper($position), 0, 1, 'L', true);
    $pdf->Ln(4);
    
    // Table header
    $pdf->SetFont('helvetica', 'B', 11);
    $pdf->SetFillColor(50, 100, 150);
    $pdf->SetTextColor(255, 255, 255);
    $pdf->Cell(120, 8, 'CANDIDATE NAME', 1, 0, 'L', true);
    $pdf->Cell(50, 8, 'VOTES RECEIVED', 1, 1, 'C', true);
    
    // Reset text color for candidate rows
    $pdf->SetTextColor(0, 0, 0);
    
    // Candidate rows
    $pdf->SetFont('helvetica', '', 11);
    $fill = false;
    
    foreach ($candidates as $index => $candidate) {
        // Alternate row colors
        $fill = !$fill;
        if ($fill) {
            $pdf->SetFillColor(245, 245, 245);
        } else {
            $pdf->SetFillColor(255, 255, 255);
        }
        
        // Candidate name
        $pdf->Cell(
            120, 
            8, 
            htmlspecialchars($candidate['last_name'] . ', ' . $candidate['first_name'] . ' ' . $candidate['middle_name'] . ' (' . $candidate['year'] . ' - ' . $candidate['section'] . ')'), 
            1, 0, 'L', $fill
        );
        
        // Votes with WINNER indicator for first place
        if ($index === 0) {
            $pdf->SetFont('', 'B');
            $pdf->Cell(50, 8, number_format($candidate['votes']) . ' (WINNER)', 1, 1, 'C', $fill);
            $pdf->SetFont('', '');
        } else {
            $pdf->Cell(50, 8, number_format($candidate['votes']), 1, 1, 'C', $fill);
        }
    }
    
    $pdf->Ln(12);
}

// Footer
$pdf->SetY(-20);
$pdf->SetFont('helvetica', 'I', 9);
$pdf->Cell(0, 10, 'This is an official document generated by the College Voting System', 0, 0, 'C');

// Output PDF
$pdf->Output('CCS_Election_Results_' . date('Y-m-d') . '.pdf', 'I');

exit();
?>